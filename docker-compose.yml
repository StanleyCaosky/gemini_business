services:
  # API 服务
  gemini-api:
    build: .
    ports:
      - "7860:7860"
    volumes:
      - ./data:/app/data
    env_file:
      - .env
    restart: unless-stopped
    profiles:
      - all

  # 账号注册服务
  register:
    build: .
    volumes:
      - ./data:/app/data
    environment:
      # 注册数量
      - TOTAL_ACCOUNTS=1
      # 临时邮箱配置
      - MAIL_BASE_URL=https://email-worker.2668812066.workers.dev
      - MAIL_DOMAIN=220901.xyz
      # 账号文件（容器内路径）
      - ACCOUNTS_FILE=/app/data/accounts.json
    command: ["python", "-u", "script/register_accounts.py"]
    profiles:
      - register

  # 账号守护服务（自动维护账号数量）
  keeper:
    build: .
    volumes:
      - ./data:/app/data
    environment:
      # 最少保持账号数
      - MIN_ACCOUNTS=5
      # 检测间隔（秒）
      - CHECK_INTERVAL=3600
      # 账号文件
      - ACCOUNTS_FILE=/app/data/accounts.json
      # 临时邮箱配置（用于注册新账号）
      - MAIL_BASE_URL=https://email-worker.2668812066.workers.dev
      - MAIL_DOMAIN=220901.xyz
    command: ["python", "-u", "script/account_keeper.py"]
    restart: unless-stopped
    profiles:
      - keeper
      - all
